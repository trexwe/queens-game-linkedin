name: Auto-merge Upstream

on:
  schedule:
    # Run daily at 2 PM UTC
    - cron: '0 14 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (show what would be merged without committing)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  actions: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Configure "ours" merge driver - keeps our version on conflict
          # Used by .gitattributes for: levels.ts, README.md, package.json
          git config merge.ours.name "Keep ours"
          git config merge.ours.driver "true"

      - name: Check for upstream updates
        id: check
        run: |
          git remote add upstream https://github.com/samimsu/queens-game-linkedin.git
          git fetch upstream

          if git merge-base --is-ancestor upstream/main HEAD; then
            echo "up_to_date=true" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date with upstream"
          else
            echo "up_to_date=false" >> $GITHUB_OUTPUT
            echo "### Commits to merge:" >> $GITHUB_STEP_SUMMARY
            git log HEAD..upstream/main --oneline >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set up Node.js
        if: steps.check.outputs.up_to_date == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        if: steps.check.outputs.up_to_date == 'false'
        run: npm ci --legacy-peer-deps

      - name: Run auto-merge
        if: steps.check.outputs.up_to_date == 'false'
        run: |
          chmod +x scripts/auto-merge-upstream.sh
          scripts/auto-merge-upstream.sh

      - name: Run tests
        if: steps.check.outputs.up_to_date == 'false'
        run: npm test -- --run

      - name: Push changes
        id: push
        if: steps.check.outputs.up_to_date == 'false' && github.event.inputs.dry_run != 'true'
        run: |
          for i in 1 2 3 4; do
            if git push origin main; then
              echo "âœ… Push successful"
              echo "push_success=true" >> $GITHUB_OUTPUT
              echo "### âœ… Auto-merge Successful" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Merge commit:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              git log -1 --oneline >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              exit 0
            fi
            if [ $i -eq 4 ]; then
              echo "âŒ Push failed after 4 attempts"
              exit 1
            fi
            sleep $((2 ** i))
          done

      - name: Trigger deploy workflow
        if: steps.push.outputs.push_success == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Triggering deploy workflow..."
          gh workflow run deploy.yml --ref main -R ${{ github.repository }}
          echo "âœ… Deploy workflow triggered" >> $GITHUB_STEP_SUMMARY

      - name: Dry run notice
        if: steps.check.outputs.up_to_date == 'false' && github.event.inputs.dry_run == 'true'
        run: |
          echo "### ðŸƒ Dry Run Complete" >> $GITHUB_STEP_SUMMARY
          echo "Changes not pushed. Merge commit:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          git log -1 --oneline >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
